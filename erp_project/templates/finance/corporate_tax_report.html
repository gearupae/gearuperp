{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h4 class="mb-1 fw-bold">{{ title }}</h4>
        <p class="text-muted mb-0">UAE Corporate Tax - Federal Decree-Law No. 47 of 2022</p>
    </div>
    <div class="d-flex gap-2">
        {% if selected_fiscal_year %}
        <a href="?fiscal_year={{ selected_fiscal_year.pk }}&format=excel" class="btn btn-success">
            <i class="fas fa-file-excel me-1"></i>Excel
        </a>
        {% endif %}
        <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="fas fa-print me-1"></i>Print
        </button>
        {% if can_create and selected_fiscal_year and not existing_computation %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaxModal">
            <i class="fas fa-plus me-1"></i>Create Computation
        </button>
        {% endif %}
    </div>
</div>

<!-- Fiscal Year Filter -->
<div class="card mb-4">
    <div class="card-body py-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-medium">Fiscal Year</label>
                <select name="fiscal_year" class="form-select" onchange="this.form.submit()">
                    {% for fy in fiscal_years %}
                    <option value="{{ fy.pk }}" {% if selected_fiscal_year.pk == fy.pk %}selected{% endif %}>
                        {{ fy.name }} ({{ fy.start_date|date:"d M Y" }} - {{ fy.end_date|date:"d M Y" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <span class="text-muted small">
                    Period: {{ start_date }} to {{ end_date }}
                </span>
            </div>
        </form>
    </div>
</div>

<!-- Tax Info Alert -->
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>UAE Corporate Tax:</strong> Tax rate of 9% applies to taxable income exceeding AED 375,000.
    Taxable income is calculated as: <em>Accounting Profit + Non-deductible Expenses - Exempt Income ± Other Adjustments</em>
</div>

<!-- Current Year Computation from GL (Quick View) -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0 fw-bold"><i class="fas fa-calculator me-2"></i>Current Period - From General Ledger</h6>
    </div>
    <div class="card-body">
        <table class="table table-borderless mb-0">
            <tbody>
                <tr class="border-bottom">
                    <td class="fw-medium" width="50%">Total Revenue (Income Accounts)</td>
                    <td class="text-end">AED {{ current_revenue|floatformat:2|intcomma }}</td>
                </tr>
                <tr class="border-bottom">
                    <td class="fw-medium">Less: Total Expenses (Expense Accounts)</td>
                    <td class="text-end">(AED {{ current_expenses|floatformat:2|intcomma }})</td>
                </tr>
                <tr class="border-bottom table-light">
                    <td class="fw-bold">Accounting Profit (Before Adjustments)</td>
                    <td class="text-end fw-bold {% if accounting_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                        AED {{ accounting_profit|floatformat:2|intcomma }}
                    </td>
                </tr>
                <tr class="border-bottom">
                    <td class="text-muted">Tax Threshold</td>
                    <td class="text-end text-muted">AED {{ tax_threshold|floatformat:2|intcomma }}</td>
                </tr>
                <tr class="border-bottom">
                    <td class="fw-medium">Amount Exceeding Threshold</td>
                    <td class="text-end">
                        {% if taxable_amount > 0 %}
                            AED {{ taxable_amount|floatformat:2|intcomma }}
                        {% else %}
                            <span class="text-muted">Below Threshold</span>
                        {% endif %}
                    </td>
                </tr>
                <tr class="table-{% if tax_payable_estimate > 0 %}warning{% else %}success{% endif %}">
                    <td class="fw-bold fs-5">Estimated Tax ({{ tax_rate }}%)</td>
                    <td class="text-end fw-bold fs-5">AED {{ tax_payable_estimate|floatformat:2|intcomma }}</td>
                </tr>
            </tbody>
        </table>
        <p class="text-muted small mt-3 mb-0">
            <i class="fas fa-info-circle me-1"></i>
            This is an estimate before tax adjustments. Create a formal computation to apply add-backs and exclusions.
        </p>
    </div>
</div>

<!-- Existing Computation for Selected Year -->
{% if existing_computation %}
<div class="card mb-4 border-primary">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold">
            <i class="fas fa-file-invoice-dollar me-2"></i>
            Tax Computation: {{ existing_computation.fiscal_year.name }}
        </h6>
        <span class="badge {% if existing_computation.status == 'draft' %}bg-secondary{% elif existing_computation.status == 'final' %}bg-primary{% elif existing_computation.status == 'filed' %}bg-info{% else %}bg-success{% endif %}">
            {{ existing_computation.get_status_display }}
        </span>
    </div>
    
    <!-- Data Source Info -->
    <div class="alert alert-info mb-0 border-0 rounded-0 py-2">
        <i class="fas fa-database me-2"></i>
        <strong>Data Source:</strong> All figures below are calculated from current General Ledger entries.
        Adjustments are from the saved computation.
    </div>
    
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold text-muted mb-3">Step 1: Accounting Profit (From General Ledger)</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Total Revenue</td>
                        <td class="text-end">AED {{ comp_revenue|floatformat:2|intcomma }}</td>
                    </tr>
                    <tr>
                        <td>Less: Total Expenses</td>
                        <td class="text-end">(AED {{ comp_expenses|floatformat:2|intcomma }})</td>
                    </tr>
                    <tr class="table-light fw-bold">
                        <td>Accounting Profit</td>
                        <td class="text-end {% if comp_accounting_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            AED {{ comp_accounting_profit|floatformat:2|intcomma }}
                        </td>
                    </tr>
                </table>
                
                <h6 class="fw-bold text-muted mb-3 mt-4">Step 2: Tax Adjustments</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Add: Non-deductible Expenses</td>
                        <td class="text-end text-danger">+ AED {{ comp_non_deductible|floatformat:2|intcomma }}</td>
                    </tr>
                    <tr>
                        <td>Less: Exempt Income</td>
                        <td class="text-end text-success">- AED {{ comp_exempt_income|floatformat:2|intcomma }}</td>
                    </tr>
                    <tr>
                        <td>Other Adjustments</td>
                        <td class="text-end">AED {{ comp_other_adjustments|floatformat:2|intcomma }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold text-muted mb-3">Step 3: Taxable Income</h6>
                <table class="table table-sm">
                    <tr class="table-light fw-bold">
                        <td>Taxable Income</td>
                        <td class="text-end">AED {{ comp_taxable_income|floatformat:2|intcomma }}</td>
                    </tr>
                    <tr>
                        <td>Tax Threshold</td>
                        <td class="text-end">AED {{ tax_threshold|floatformat:2|intcomma }}</td>
                    </tr>
                    <tr>
                        <td>Amount Above Threshold</td>
                        <td class="text-end">
                            {% if comp_taxable_above_threshold > 0 %}
                            AED {{ comp_taxable_above_threshold|floatformat:2|intcomma }}
                            {% else %}
                            <span class="text-muted">Below Threshold</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
                
                <h6 class="fw-bold text-muted mb-3 mt-4">Step 4: Tax Calculation</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Tax Rate</td>
                        <td class="text-end">{{ tax_rate }}%</td>
                    </tr>
                    <tr class="table-{% if comp_tax_payable > 0 %}warning{% else %}success{% endif %} fw-bold fs-5">
                        <td>Tax Payable</td>
                        <td class="text-end">AED {{ comp_tax_payable|floatformat:2|intcomma }}</td>
                    </tr>
                </table>
                
                {% if existing_computation.provision_posted %}
                <div class="alert alert-success py-2 mb-2">
                    <small>
                        <i class="fas fa-check-circle me-1"></i>
                        Provision Posted: {{ existing_computation.provision_date|date:"d M Y" }}
                        {% if existing_computation.journal_entry %}
                        - <a href="{% url 'finance:journal_detail' existing_computation.journal_entry.pk %}">{{ existing_computation.journal_entry.entry_number }}</a>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                
                {% if existing_computation.status == 'paid' %}
                <div class="alert alert-info py-2 mb-2">
                    <small>
                        <i class="fas fa-check-circle me-1"></i>
                        Paid: AED {{ existing_computation.paid_amount|floatformat:2|intcomma }} on {{ existing_computation.payment_date|date:"d M Y" }}
                        {% if existing_computation.payment_journal_entry %}
                        - <a href="{% url 'finance:journal_detail' existing_computation.payment_journal_entry.pk %}">{{ existing_computation.payment_journal_entry.entry_number }}</a>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if existing_computation.notes %}
        <div class="mt-3 p-3 bg-light rounded">
            <small class="text-muted">Notes:</small><br>
            {{ existing_computation.notes }}
        </div>
        {% endif %}
        
        <!-- Action Buttons -->
        {% if can_post %}
        <div class="mt-4 d-flex gap-2">
            {% if not existing_computation.provision_posted and existing_computation.tax_payable > 0 %}
            <form method="post" action="{% url 'finance:corporate_tax_post_provision' existing_computation.pk %}" 
                  onsubmit="return confirm('Post tax provision journal entry?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-book me-1"></i>Post Provision
                </button>
            </form>
            {% endif %}
            
            {% if existing_computation.provision_posted and existing_computation.balance_due > 0 %}
            <a href="{% url 'finance:corporate_tax_pay' existing_computation.pk %}" class="btn btn-success">
                <i class="fas fa-credit-card me-1"></i>Pay Tax (AED {{ existing_computation.balance_due|floatformat:2|intcomma }})
            </a>
            {% endif %}
        </div>
        {% endif %}
</div>
</div>
{% endif %}

<!-- Tax Rules & Journal Preview -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0 fw-bold"><i class="fas fa-book me-2"></i>Tax Provision Journal</h6>
            </div>
            <div class="card-body">
                {% if tax_payable_estimate > 0 %}
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Account</th>
                            <th class="text-end">Debit</th>
                            <th class="text-end">Credit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Corporate Tax Expense</td>
                            <td class="text-end">{{ tax_payable_estimate|floatformat:2|intcomma }}</td>
                            <td class="text-end text-muted">-</td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;Corporate Tax Payable</td>
                            <td class="text-end text-muted">-</td>
                            <td class="text-end">{{ tax_payable_estimate|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    This journal is posted when you finalize the tax computation.
                </p>
                {% else %}
                <p class="text-muted mb-0">No tax provision required when profit is below threshold.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0 fw-bold"><i class="fas fa-clipboard-list me-2"></i>UAE Tax Rules</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Tax Rate: <strong>9%</strong> on profit above threshold
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Threshold: <strong>AED 375,000</strong> (Small Business Relief)
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-plus text-danger me-2"></i>
                        <strong>Add-backs:</strong> Fines, penalties, non-business expenses
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-minus text-success me-2"></i>
                        <strong>Exclusions:</strong> Qualifying dividends, exempt capital gains
                    </li>
                    <li>
                        <i class="fas fa-calendar text-primary me-2"></i>
                        Filing deadline: Within 9 months of fiscal year end
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Past Computations -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold"><i class="fas fa-history me-2"></i>Tax Computation History</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fiscal Year</th>
                        <th class="text-end">Revenue</th>
                        <th class="text-end">Expenses</th>
                        <th class="text-end">Accounting Profit</th>
                        <th class="text-end">Adjustments</th>
                        <th class="text-end">Taxable Income</th>
                        <th class="text-end">Tax Payable</th>
                        <th class="text-end">Paid</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comp in tax_computations %}
                    <tr>
                        <td class="fw-medium">{{ comp.fiscal_year.name }}</td>
                        <td class="text-end">{{ comp.revenue|floatformat:2|intcomma }}</td>
                        <td class="text-end">{{ comp.expenses|floatformat:2|intcomma }}</td>
                        <td class="text-end">{{ comp.accounting_profit|floatformat:2|intcomma }}</td>
                        <td class="text-end">
                            <span class="{% if comp.non_deductible_expenses > 0 %}text-danger{% endif %}">+{{ comp.non_deductible_expenses|floatformat:0|intcomma }}</span>
                            /
                            <span class="{% if comp.exempt_income > 0 %}text-success{% endif %}">-{{ comp.exempt_income|floatformat:0|intcomma }}</span>
                        </td>
                        <td class="text-end fw-medium">{{ comp.taxable_income|floatformat:2|intcomma }}</td>
                        <td class="text-end fw-bold">{{ comp.tax_payable|floatformat:2|intcomma }}</td>
                        <td class="text-end">{{ comp.paid_amount|floatformat:2|intcomma }}</td>
                        <td>
                            {% if comp.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                            {% elif comp.status == 'final' %}
                                <span class="badge bg-primary">Final</span>
                            {% elif comp.status == 'filed' %}
                                <span class="badge bg-info">Filed</span>
                            {% elif comp.status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                            {% endif %}
                            {% if comp.provision_posted %}
                                <span class="badge bg-light text-dark"><i class="fas fa-check"></i> Posted</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-5 text-muted">
                            <i class="fas fa-landmark fa-3x mb-3 d-block"></i>
                            No tax computations recorded
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Tax Computation Modal -->
<div class="modal fade" id="createTaxModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'finance:corporate_tax_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-calculator me-2"></i>Create Tax Computation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="fiscal_year" value="{{ selected_fiscal_year.pk }}">
                    
                    <div class="alert alert-info">
                        <strong>Fiscal Year:</strong> {{ selected_fiscal_year.name }} 
                        ({{ selected_fiscal_year.start_date|date:"d M Y" }} - {{ selected_fiscal_year.end_date|date:"d M Y" }})
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="fw-bold text-primary">Step 1: Accounting Profit (From General Ledger)</h6>
                            <p class="text-muted small mb-3">
                                <i class="fas fa-lock me-1"></i>
                                These values are calculated from posted journal entries. They cannot be edited to ensure consistency.
                            </p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Total Revenue</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="text" class="form-control bg-light fw-bold text-success" 
                                       value="{{ current_revenue|floatformat:2|intcomma }}" readonly disabled>
                            </div>
                            <small class="text-muted">From Income accounts</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Total Expenses</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="text" class="form-control bg-light fw-bold text-danger" 
                                       value="{{ current_expenses|floatformat:2|intcomma }}" readonly disabled>
                            </div>
                            <small class="text-muted">From Expense accounts</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Accounting Profit</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="text" class="form-control bg-light fw-bold {% if accounting_profit >= 0 %}text-success{% else %}text-danger{% endif %}" 
                                       value="{{ accounting_profit|floatformat:2|intcomma }}" readonly disabled>
                            </div>
                            <small class="text-muted">Revenue - Expenses</small>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="fw-bold text-danger">Step 2: Tax Adjustments</h6>
                            <p class="text-muted small">These amounts modify the accounting profit to arrive at taxable income.</p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Non-deductible Expenses (+)</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="number" name="non_deductible_expenses" class="form-control" step="0.01" value="0">
                            </div>
                            <small class="text-muted">Fines, penalties, entertainment</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Exempt Income (-)</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="number" name="exempt_income" class="form-control" step="0.01" value="0">
                            </div>
                            <small class="text-muted">Qualifying dividends, exempt gains</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Other Adjustments (±)</label>
                            <div class="input-group">
                                <span class="input-group-text">AED</span>
                                <input type="number" name="other_adjustments" class="form-control" step="0.01" value="0">
                            </div>
                            <small class="text-muted">Depreciation, provisions</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" 
                                  placeholder="Any notes for the auditor..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Create & Calculate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
