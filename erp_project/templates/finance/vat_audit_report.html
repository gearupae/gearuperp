{% extends 'base.html' %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h4 class="mb-0 fw-bold">{{ title }}</h4>
        <small class="text-muted">Line-level VAT details for FTA audit compliance</small>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-dark" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Print
        </button>
        <button class="btn btn-outline-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-2"></i>Export
        </button>
    </div>
</div>

<!-- Date Filter -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-dark">
                    <i class="fas fa-filter me-2"></i>Generate Report
                </button>
            </div>
        </form>
    </div>
</div>

<!-- VAT Box Summary -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h6 class="mb-0 fw-bold"><i class="fas fa-chart-bar me-2"></i>VAT Box Summary</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>VAT Box</th>
                        <th class="text-center">Transactions</th>
                        <th class="text-end">Debit</th>
                        <th class="text-end">Credit</th>
                        <th class="text-end">Net</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Box 1a</strong> - Standard Supplies (Emirates)</td>
                        <td class="text-center">{{ box_totals.box1a.count }}</td>
                        <td class="text-end">{{ box_totals.box1a.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box1a.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box1a.net|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Box 3</strong> - Zero-rated Supplies</td>
                        <td class="text-center">{{ box_totals.box3.count }}</td>
                        <td class="text-end">{{ box_totals.box3.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box3.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box3.net|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Box 4</strong> - Exempt Supplies</td>
                        <td class="text-center">{{ box_totals.box4.count }}</td>
                        <td class="text-end">{{ box_totals.box4.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box4.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box4.net|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Box 6</strong> - Standard Expenses</td>
                        <td class="text-center">{{ box_totals.box6.count }}</td>
                        <td class="text-end">{{ box_totals.box6.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box6.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box6.net|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-success">
                        <td><strong>Box 9</strong> - Output VAT Due</td>
                        <td class="text-center">{{ box_totals.box9.count }}</td>
                        <td class="text-end">{{ box_totals.box9.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box9.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box9.net|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-warning">
                        <td><strong>Box 10</strong> - Input VAT Recoverable</td>
                        <td class="text-center">{{ box_totals.box10.count }}</td>
                        <td class="text-end">{{ box_totals.box10.debit|floatformat:2 }}</td>
                        <td class="text-end">{{ box_totals.box10.credit|floatformat:2 }}</td>
                        <td class="text-end fw-bold">{{ box_totals.box10.net|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Transaction Details -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Transaction Details ({{ total_transactions }} records)</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="vatAuditTable">
                <thead class="bg-light">
                    <tr>
                        <th>Date</th>
                        <th>Entry #</th>
                        <th>Reference</th>
                        <th>Description</th>
                        <th>Account</th>
                        <th class="text-end">Debit</th>
                        <th class="text-end">Credit</th>
                        <th>VAT Box</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr>
                        <td>{{ txn.date|date:"d/m/Y" }}</td>
                        <td class="fw-medium">{{ txn.entry_number }}</td>
                        <td>{{ txn.reference|default:"-" }}</td>
                        <td>{{ txn.description|truncatechars:40 }}</td>
                        <td>{{ txn.account.code }}</td>
                        <td class="text-end">{% if txn.debit > 0 %}{{ txn.debit|floatformat:2 }}{% endif %}</td>
                        <td class="text-end">{% if txn.credit > 0 %}{{ txn.credit|floatformat:2 }}{% endif %}</td>
                        <td>
                            {% if 'Box 9' in txn.vat_box %}
                            <span class="badge bg-success">{{ txn.vat_box }}</span>
                            {% elif 'Box 10' in txn.vat_box %}
                            <span class="badge bg-warning text-dark">{{ txn.vat_box }}</span>
                            {% elif 'Box 1' in txn.vat_box %}
                            <span class="badge bg-primary">{{ txn.vat_box }}</span>
                            {% elif 'Box 6' in txn.vat_box %}
                            <span class="badge bg-info">{{ txn.vat_box }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ txn.vat_box }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p class="mb-0">No transactions found for the selected period.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- FTA Compliance Note -->
<div class="alert alert-info mt-4">
    <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>FTA Audit Compliance</h6>
    <hr>
    <p class="mb-0">This report provides line-level VAT transaction details as required by the UAE Federal Tax Authority (FTA) for VAT audits. All amounts are in AED. The report maps transactions to the standard VAT return boxes for easy reconciliation.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#vatAuditTable').DataTable({
        "order": [[0, "asc"]],
        "pageLength": 50,
        "dom": 'Bfrtip',
        "buttons": ['copy', 'csv', 'excel', 'pdf']
    });
});

function exportToExcel() {
    // Trigger DataTables export
    $('#vatAuditTable').DataTable().button('.buttons-excel').trigger();
}
</script>
{% endblock %}


