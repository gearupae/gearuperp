{% extends 'base.html' %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{% url 'purchase:bill_list' %}">Vendor Bills</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
    <h4 class="mb-0 fw-bold">{{ title }}</h4>
</div>

{% if form.errors and form.errors.items %}
<div class="alert alert-danger mb-4">
    <h6 class="alert-heading mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Please correct the errors below:</h6>
    {% for field, errors in form.errors.items %}
        <div><strong>{{ field }}:</strong> {{ errors|join:", " }}</div>
    {% endfor %}
</div>
{% endif %}
{% if items_formset.non_form_errors %}
<div class="alert alert-danger mb-4">
    <h6 class="alert-heading mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Item Errors:</h6>
    <div>{{ items_formset.non_form_errors|join:", " }}</div>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    
    <div class="card mb-4">
        <div class="card-header"><h6 class="mb-0 fw-semibold">Bill Details</h6></div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Vendor <span class="text-danger">*</span></label>
                    {{ form.vendor }}
                    {% if form.vendor.errors %}<div class="text-danger small">{{ form.vendor.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Vendor Invoice #</label>
                    {{ form.vendor_invoice_number }}
                    {% if form.vendor_invoice_number.errors %}<div class="text-danger small">{{ form.vendor_invoice_number.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">From PO</label>
                    {{ form.purchase_order }}
                    {% if form.purchase_order.errors %}<div class="text-danger small">{{ form.purchase_order.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Bill Date <span class="text-danger">*</span></label>
                    {{ form.bill_date }}
                    {% if form.bill_date.errors %}<div class="text-danger small">{{ form.bill_date.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Due Date <span class="text-danger">*</span></label>
                    {{ form.due_date }}
                    {% if form.due_date.errors %}<div class="text-danger small">{{ form.due_date.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    {{ form.status }}
                    {% if form.status.errors %}<div class="text-danger small">{{ form.status.errors|join:", " }}</div>{% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">Line Items</h6>
            <button type="button" class="btn btn-sm btn-primary" onclick="addItemRow()">
                <i class="fas fa-plus me-1"></i>Add Item
            </button>
        </div>
        <div class="card-body p-0">
            {{ items_formset.management_form }}
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th style="width:40%">Description</th>
                            <th style="width:12%">Qty</th>
                            <th style="width:15%">Unit Price</th>
                            <th style="width:10%">VAT %</th>
                            <th style="width:15%" class="text-end">Total</th>
                            <th style="width:8%"></th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        {% for item_form in items_formset %}
                        <tr class="item-row" {% if item_form.DELETE.value %}style="display:none;"{% endif %}>
                            <td>
                                {{ item_form.id }}
                                <input type="text" name="{{ item_form.prefix }}-description" class="form-control" 
                                       value="{{ item_form.description.value|default:'' }}" placeholder="Item description">
                            </td>
                            <td>
                                <input type="number" name="{{ item_form.prefix }}-quantity" class="form-control item-qty" 
                                       value="{{ item_form.quantity.value|default:1 }}" step="0.01" min="0.01" onchange="calculateRowTotal(this)">
                            </td>
                            <td>
                                <input type="number" name="{{ item_form.prefix }}-unit_price" class="form-control item-price" 
                                       value="{{ item_form.unit_price.value|default:0 }}" step="0.01" min="0" onchange="calculateRowTotal(this)">
                            </td>
                            <td>
                                <input type="number" name="{{ item_form.prefix }}-vat_rate" class="form-control item-vat" 
                                       value="{{ item_form.vat_rate.value|default:5 }}" step="0.01" min="0" onchange="calculateRowTotal(this)">
                            </td>
                            <td class="text-end"><span class="row-total fw-medium">0.00</span></td>
                            <td class="text-center">
                                {% if item_form.instance.pk %}
                                <input type="checkbox" name="{{ item_form.prefix }}-DELETE" class="d-none delete-check"
                                       {% if item_form.DELETE.value %}checked{% endif %}>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end">Subtotal:</td>
                            <td class="text-end fw-medium" id="subtotal">0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-end">VAT:</td>
                            <td class="text-end fw-medium" id="vatTotal">0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total:</td>
                            <td class="text-end fw-bold" id="grandTotal">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save</button>
    <a href="{% url 'purchase:bill_list' %}" class="btn btn-light">Cancel</a>
</form>

{% block extra_js %}
<script>
let formCount = {{ items_formset.total_form_count }};

function addItemRow(description = '', quantity = '1', unitPrice = '0', vatRate = '5') {
    const tbody = document.getElementById('itemsBody');
    const newRow = document.createElement('tr');
    newRow.className = 'item-row';
    newRow.innerHTML = `
        <td><input type="text" name="items-${formCount}-description" class="form-control" value="${description}" placeholder="Item description"></td>
        <td><input type="number" name="items-${formCount}-quantity" class="form-control item-qty" value="${quantity}" step="0.01" min="0.01" onchange="calculateRowTotal(this)"></td>
        <td><input type="number" name="items-${formCount}-unit_price" class="form-control item-price" value="${unitPrice}" step="0.01" min="0" onchange="calculateRowTotal(this)"></td>
        <td><input type="number" name="items-${formCount}-vat_rate" class="form-control item-vat" value="${vatRate}" step="0.01" min="0" onchange="calculateRowTotal(this)"></td>
        <td class="text-end"><span class="row-total fw-medium">0.00</span></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(this)"><i class="fas fa-times"></i></button></td>
    `;
    tbody.appendChild(newRow);
    formCount++;
    document.getElementById('id_items-TOTAL_FORMS').value = formCount;
    // Calculate totals for the new row
    const qtyInput = newRow.querySelector('.item-qty');
    if (qtyInput) calculateRowTotal(qtyInput);
}

function removeItemRow(btn) {
    const row = btn.closest('tr');
    const deleteCheck = row.querySelector('.delete-check');
    if (deleteCheck) { deleteCheck.checked = true; row.style.display = 'none'; }
    else { row.remove(); }
    calculateTotals();
}

function calculateRowTotal(input) {
    const row = input.closest('tr');
    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    row.querySelector('.row-total').textContent = (qty * price).toFixed(2);
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0, vatTotal = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        if (row.style.display === 'none') return;
        const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
        const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
        const vatRate = parseFloat(row.querySelector('.item-vat')?.value) || 0;
        const total = qty * price;
        subtotal += total;
        vatTotal += total * (vatRate / 100);
    });
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('vatTotal').textContent = vatTotal.toFixed(2);
    document.getElementById('grandTotal').textContent = (subtotal + vatTotal).toFixed(2);
}

function loadPOItems(poId) {
    if (!poId) {
        // Clear items if no PO selected
        const tbody = document.getElementById('itemsBody');
        tbody.innerHTML = '';
        formCount = 0;
        document.getElementById('id_items-TOTAL_FORMS').value = 0;
        calculateTotals();
        return;
    }
    
    // Fetch PO items via AJAX
    const url = `/purchase/orders/${poId}/items/`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Clear existing items
            const tbody = document.getElementById('itemsBody');
            tbody.innerHTML = '';
            formCount = 0;
            
            // Add PO items
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    addItemRow(
                        item.description || '',
                        item.quantity || '1',
                        item.unit_price || '0',
                        item.vat_rate || '5'
                    );
                });
            } else {
                // If no items, add one empty row
                addItemRow();
            }
            
            // Update vendor if PO has a vendor
            if (data.vendor_id) {
                const vendorSelect = document.getElementById('id_vendor');
                if (vendorSelect) {
                    vendorSelect.value = data.vendor_id;
                }
            }
            
            calculateTotals();
        })
        .catch(error => {
            console.error('Error loading PO items:', error);
            alert('Error loading Purchase Order items. Please try again.');
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // Calculate totals for existing rows
    document.querySelectorAll('.item-row').forEach(row => {
        const qty = row.querySelector('.item-qty');
        if (qty) calculateRowTotal(qty);
    });
    
    // Listen for PO selection change
    const poSelect = document.getElementById('id_purchase_order');
    if (poSelect) {
        poSelect.addEventListener('change', function() {
            const poId = this.value;
            if (poId) {
                // Confirm before loading PO items (only if there are existing items)
                const existingRows = document.querySelectorAll('.item-row:not([style*="display: none"])');
                if (existingRows.length > 0) {
                    if (!confirm('Loading PO items will replace existing items. Continue?')) {
                        return;
                    }
                }
                loadPOItems(poId);
            } else {
                // Clear items if PO is deselected
                loadPOItems(null);
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %}
