{% extends 'base.html' %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{% url 'sales:invoice_list' %}">Invoices</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
    <h4 class="mb-0 fw-bold">{{ title }}</h4>
</div>

{% if form.errors and form.errors.items %}
<div class="alert alert-danger mb-4">
    <h6 class="alert-heading mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Please correct the errors below:</h6>
    {% for field, errors in form.errors.items %}
        <div><strong>{{ field }}:</strong> {{ errors|join:", " }}</div>
    {% endfor %}
</div>
{% endif %}
{% if items_formset.non_form_errors %}
<div class="alert alert-danger mb-4">
    <h6 class="alert-heading mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Item Errors:</h6>
    <div>{{ items_formset.non_form_errors|join:", " }}</div>
</div>
{% endif %}

<form method="post" id="invoiceForm">
    {% csrf_token %}
    
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0 fw-semibold"><i class="fas fa-info-circle me-2"></i>Invoice Details</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Customer <span class="text-danger">*</span></label>
                    {{ form.customer }}
                    {% if form.customer.errors %}<div class="text-danger small">{{ form.customer.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">From Quotation</label>
                    {{ form.quotation }}
                    {% if form.quotation.errors %}<div class="text-danger small">{{ form.quotation.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    {{ form.status }}
                    {% if form.status.errors %}<div class="text-danger small">{{ form.status.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Invoice Date <span class="text-danger">*</span></label>
                    {{ form.invoice_date }}
                    {% if form.invoice_date.errors %}<div class="text-danger small">{{ form.invoice_date.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Due Date <span class="text-danger">*</span></label>
                    {{ form.due_date }}
                    {% if form.due_date.errors %}<div class="text-danger small">{{ form.due_date.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Notes</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}<div class="text-danger small">{{ form.notes.errors|join:", " }}</div>{% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Line Items -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold"><i class="fas fa-list me-2"></i>Line Items</h6>
            <button type="button" class="btn btn-sm btn-primary" onclick="addItemRow()">
                <i class="fas fa-plus me-1"></i>Add Item
            </button>
        </div>
        <div class="card-body p-0">
            {{ items_formset.management_form }}
            <div class="table-responsive">
                <table class="table mb-0" id="itemsTable">
                    <thead>
                        <tr>
                            <th style="width: 35%">Description</th>
                            <th style="width: 10%">Qty</th>
                            <th style="width: 12%">Unit Price</th>
                            <th style="width: 18%">Tax Code</th>
                            <th style="width: 10%">VAT</th>
                            <th style="width: 10%" class="text-end">Total</th>
                            <th style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        {% for item_form in items_formset %}
                        <tr class="item-row" {% if item_form.DELETE.value %}style="display:none;"{% endif %}>
                            <td>
                                {{ item_form.id }}
                                <input type="text" name="{{ item_form.prefix }}-description" class="form-control form-control-sm" 
                                       value="{{ item_form.description.value|default:'' }}" placeholder="Item description">
                            </td>
                            <td>
                                <input type="number" name="{{ item_form.prefix }}-quantity" class="form-control form-control-sm item-qty" 
                                       value="{{ item_form.quantity.value|default:1 }}" step="0.01" min="0.01" onchange="calculateRowTotal(this)">
                            </td>
                            <td>
                                <input type="number" name="{{ item_form.prefix }}-unit_price" class="form-control form-control-sm item-price" 
                                       value="{{ item_form.unit_price.value|default:0 }}" step="0.01" min="0" onchange="calculateRowTotal(this)">
                            </td>
                            <td>
                                <select name="{{ item_form.prefix }}-tax_code" class="form-select form-select-sm item-tax-code" onchange="calculateRowTotal(this)">
                                    <option value="">-- No Tax --</option>
                                    {% for tc in tax_codes %}
                                    <option value="{{ tc.id }}" data-rate="{{ tc.rate }}"
                                            {% if item_form.tax_code.value == tc.id|stringformat:"s" or item_form.instance.tax_code_id == tc.id %}selected{% endif %}>
                                        {{ tc.code }} - {{ tc.name }} ({{ tc.rate }}%)
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="text-end">
                                <span class="row-vat text-muted small">0.00</span>
                            </td>
                            <td class="text-end">
                                <span class="row-total fw-medium">0.00</span>
                            </td>
                            <td class="text-center">
                                {% if item_form.instance.pk %}
                                <input type="checkbox" name="{{ item_form.prefix }}-DELETE" class="d-none delete-check"
                                       {% if item_form.DELETE.value %}checked{% endif %}>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end fw-medium">Subtotal:</td>
                            <td class="text-end fw-medium" id="subtotal">0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-end fw-medium">VAT:</td>
                            <td class="text-end fw-medium" id="vatTotal">0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total:</td>
                            <td class="text-end fw-bold" id="grandTotal">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Save Invoice
        </button>
        <a href="{% url 'sales:invoice_list' %}" class="btn btn-light">Cancel</a>
    </div>
</form>

{% block extra_js %}
<script>
// Tax Code data for JavaScript
const taxCodes = [
    {% for tc in tax_codes %}
    {id: {{ tc.id }}, code: '{{ tc.code }}', name: '{{ tc.name }}', rate: {{ tc.rate }}},
    {% endfor %}
];
const defaultTaxCodeId = {% if default_tax_code %}{{ default_tax_code.id }}{% else %}null{% endif %};

let formCount = {{ items_formset.total_form_count }};

function getTaxCodeOptions(selectedId) {
    let options = '<option value="">-- No Tax (Out of Scope) --</option>';
    taxCodes.forEach(tc => {
        const selected = selectedId && parseInt(selectedId) === tc.id ? 'selected' : '';
        options += `<option value="${tc.id}" data-rate="${tc.rate}" ${selected}>${tc.code} - ${tc.name} (${tc.rate}%)</option>`;
    });
    return options;
}

function addItemRow() {
    const tbody = document.getElementById('itemsBody');
    const newRow = document.createElement('tr');
    newRow.className = 'item-row';
    newRow.innerHTML = `
        <td>
            <input type="text" name="items-${formCount}-description" class="form-control form-control-sm" placeholder="Item description">
        </td>
        <td>
            <input type="number" name="items-${formCount}-quantity" class="form-control form-control-sm item-qty" value="1" step="0.01" min="0.01" onchange="calculateRowTotal(this)">
        </td>
        <td>
            <input type="number" name="items-${formCount}-unit_price" class="form-control form-control-sm item-price" value="0" step="0.01" min="0" onchange="calculateRowTotal(this)">
        </td>
        <td>
            <select name="items-${formCount}-tax_code" class="form-select form-select-sm item-tax-code" onchange="calculateRowTotal(this)">
                ${getTaxCodeOptions(defaultTaxCodeId)}
            </select>
        </td>
        <td class="text-end">
            <span class="row-vat text-muted small">0.00</span>
        </td>
        <td class="text-end">
            <span class="row-total fw-medium">0.00</span>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(this)">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
    formCount++;
    document.getElementById('id_items-TOTAL_FORMS').value = formCount;
    calculateRowTotal(newRow.querySelector('.item-qty'));
}

function removeItemRow(btn) {
    const row = btn.closest('tr');
    const deleteCheck = row.querySelector('.delete-check');
    if (deleteCheck) {
        deleteCheck.checked = true;
        row.style.display = 'none';
    } else {
        row.remove();
    }
    calculateTotals();
}

function calculateRowTotal(input) {
    const row = input.closest('tr');
    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    const taxCodeSelect = row.querySelector('.item-tax-code');
    
    // Get VAT rate from selected Tax Code
    let vatRate = 0;
    if (taxCodeSelect && taxCodeSelect.selectedOptions[0]) {
        vatRate = parseFloat(taxCodeSelect.selectedOptions[0].dataset.rate) || 0;
    }
    
    const net = qty * price;
    const vat = net * (vatRate / 100);
    
    row.querySelector('.row-vat').textContent = vat.toFixed(2);
    row.querySelector('.row-total').textContent = net.toFixed(2);
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let vatTotal = 0;
    
    document.querySelectorAll('.item-row').forEach(row => {
        if (row.style.display === 'none') return;
        const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
        const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
        const taxCodeSelect = row.querySelector('.item-tax-code');
        
        let vatRate = 0;
        if (taxCodeSelect && taxCodeSelect.selectedOptions[0]) {
            vatRate = parseFloat(taxCodeSelect.selectedOptions[0].dataset.rate) || 0;
        }
        
        const net = qty * price;
        const vat = net * (vatRate / 100);
        subtotal += net;
        vatTotal += vat;
    });
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('vatTotal').textContent = vatTotal.toFixed(2);
    document.getElementById('grandTotal').textContent = (subtotal + vatTotal).toFixed(2);
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.item-row').forEach(row => {
        const qty = row.querySelector('.item-qty');
        if (qty) calculateRowTotal(qty);
    });
});
</script>
{% endblock %}
{% endblock %}
