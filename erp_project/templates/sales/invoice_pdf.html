<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice - {{ invoice.invoice_number }}</title>
    <style>
        /* FTA Compliant Tax Invoice Template */
        @page {
            size: A4;
            margin: 15mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #333;
            background: white;
        }
        
        .invoice-container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #1a365d;
        }
        
        .company-info {
            flex: 1;
        }
        
        .company-name {
            font-size: 22px;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 5px;
        }
        
        .company-details {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
        }
        
        .company-trn {
            font-size: 11px;
            font-weight: bold;
            color: #1a365d;
            margin-top: 8px;
        }
        
        .invoice-title-section {
            text-align: right;
        }
        
        .invoice-title {
            font-size: 28px;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 5px;
        }
        
        .invoice-subtitle {
            font-size: 10px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .invoice-number-box {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 10px 15px;
            text-align: center;
        }
        
        .invoice-number {
            font-size: 14px;
            font-weight: bold;
            color: #1a365d;
        }
        
        /* Info Section */
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .info-box {
            width: 48%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 12px;
        }
        
        .info-box-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .info-box-content {
            font-size: 11px;
        }
        
        .info-box-name {
            font-size: 13px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .info-box-trn {
            font-size: 10px;
            font-weight: 600;
            color: #1a365d;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #cbd5e0;
        }
        
        .dates-section {
            width: 48%;
        }
        
        .date-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .date-row:last-child {
            border-bottom: none;
        }
        
        .date-label {
            color: #718096;
            font-size: 10px;
        }
        
        .date-value {
            font-weight: 600;
            font-size: 11px;
        }
        
        /* Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .items-table thead th {
            background: #1a365d;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .items-table thead th.text-center {
            text-align: center;
        }
        
        .items-table thead th.text-right {
            text-align: right;
        }
        
        .items-table tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
        }
        
        .items-table tbody td.text-center {
            text-align: center;
        }
        
        .items-table tbody td.text-right {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .items-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .item-number {
            color: #718096;
            font-size: 10px;
        }
        
        .item-description {
            font-weight: 500;
        }
        
        /* Totals Section */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .totals-table {
            width: 300px;
        }
        
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .totals-row.subtotal {
            background: #f8fafc;
        }
        
        .totals-row.vat-row {
            background: #fff5f5;
        }
        
        .totals-row.total {
            background: #1a365d;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .totals-label {
            color: #4a5568;
        }
        
        .totals-row.total .totals-label {
            color: white;
        }
        
        .totals-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 600;
        }
        
        /* Amount in Words */
        .amount-words {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 11px;
        }
        
        .amount-words-label {
            font-size: 9px;
            text-transform: uppercase;
            color: #276749;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .amount-words-value {
            font-weight: 600;
            color: #22543d;
        }
        
        /* VAT Summary */
        .vat-summary {
            margin-bottom: 20px;
        }
        
        .vat-summary-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .vat-summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        
        .vat-summary-table th,
        .vat-summary-table td {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
        }
        
        .vat-summary-table th {
            background: #edf2f7;
            text-align: left;
            font-weight: 600;
        }
        
        .vat-summary-table td.text-right {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        /* Terms & Notes */
        .notes-section {
            margin-bottom: 20px;
        }
        
        .notes-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .notes-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 12px;
            font-size: 10px;
            line-height: 1.5;
        }
        
        /* Footer */
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            font-size: 9px;
            color: #718096;
            text-align: center;
        }
        
        .footer-legal {
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 8px;
            line-height: 1.6;
        }
        
        /* FTA Compliance Badge */
        .fta-badge {
            display: inline-block;
            background: #c53030;
            color: white;
            padding: 3px 8px;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        
        /* Print Styles */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .invoice-container {
                padding: 0;
                max-width: none;
            }
        }
        
        /* Print Button (for HTML view) */
        .print-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .print-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .print-btn-primary {
            background: #1a365d;
            color: white;
        }
        
        .print-btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .print-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Print Actions (hidden when printing) -->
    <div class="print-actions no-print">
        <button class="print-btn print-btn-primary" onclick="window.print()">
            üñ®Ô∏è Print Invoice
        </button>
        <a href="{% url 'sales:invoice_detail' invoice.pk %}" class="print-btn print-btn-secondary">
            ‚Üê Back to Invoice
        </a>
    </div>
    
    <div class="invoice-container">
        <!-- Header -->
        <div class="header">
            <div class="company-info">
                {% if company.logo %}
                <img src="{{ company.logo.url }}" alt="{{ company.company_name }}" style="max-height: 80px; margin-bottom: 10px;">
                {% else %}
                <div class="company-name">{{ company.company_name }}</div>
                <div class="company-details">
                    {% if company.address %}{{ company.address }}<br>{% endif %}
                    {% if company.phone %}Tel: {{ company.phone }}{% endif %}
                    {% if company.email %} | {{ company.email }}{% endif %}
                </div>
                {% if company.tax_id %}
                <div class="company-trn">TRN: {{ company.tax_id }}</div>
                {% endif %}
                {% endif %}
            </div>
            <div class="invoice-title-section">
                <div class="invoice-title">TAX INVOICE</div>
                <div class="invoice-number-box">
                    <div class="invoice-number">{{ invoice.invoice_number }}</div>
                </div>
                <div class="fta-badge">UAE VAT Compliant</div>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="info-section">
            <div class="info-box">
                <div class="info-box-title">Bill To</div>
                <div class="info-box-content">
                    <div class="info-box-name">{{ invoice.customer.company|default:invoice.customer.name }}</div>
                    {% if invoice.customer.company and invoice.customer.name != invoice.customer.company %}
                    <div>Attn: {{ invoice.customer.name }}</div>
                    {% endif %}
                    {% if invoice.customer.address %}
                    <div>{{ invoice.customer.address }}</div>
                    {% endif %}
                    {% if invoice.customer.city %}
                    <div>{{ invoice.customer.city }}{% if invoice.customer.country %}, {{ invoice.customer.country }}{% endif %}</div>
                    {% endif %}
                    {% if invoice.customer.phone %}
                    <div>Tel: {{ invoice.customer.phone }}</div>
                    {% endif %}
                    {% if invoice.customer.email %}
                    <div>{{ invoice.customer.email }}</div>
                    {% endif %}
                    {% if invoice.customer.trn %}
                    <div class="info-box-trn">TRN: {{ invoice.customer.trn }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="dates-section">
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px;">
                    <div class="info-box-title">Invoice Details</div>
                    <div class="date-row">
                        <span class="date-label">Invoice Date</span>
                        <span class="date-value">{{ invoice.invoice_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="date-row">
                        <span class="date-label">Due Date</span>
                        <span class="date-value">{{ invoice.due_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="date-row">
                        <span class="date-label">Supply Date</span>
                        <span class="date-value">{{ invoice.invoice_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="date-row">
                        <span class="date-label">Customer ID</span>
                        <span class="date-value">{{ invoice.customer.customer_number }}</span>
                    </div>
                    {% if invoice.quotation %}
                    <div class="date-row">
                        <span class="date-label">Quotation Ref</span>
                        <span class="date-value">{{ invoice.quotation.quotation_number }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 30px;">#</th>
                    <th>Description</th>
                    <th class="text-center" style="width: 60px;">Qty</th>
                    <th class="text-right" style="width: 100px;">Unit Price</th>
                    <th class="text-center" style="width: 60px;">VAT %</th>
                    <th class="text-right" style="width: 90px;">VAT Amt</th>
                    <th class="text-right" style="width: 110px;">Total (AED)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in invoice.items.all %}
                <tr>
                    <td class="item-number">{{ forloop.counter }}</td>
                    <td class="item-description">{{ item.description }}</td>
                    <td class="text-center">{{ item.quantity|floatformat:2 }}</td>
                    <td class="text-right">{{ item.unit_price|floatformat:2 }}</td>
                    <td class="text-center">{{ item.vat_rate|floatformat:0 }}%</td>
                    <td class="text-right">{{ item.vat_amount|floatformat:2 }}</td>
                    <td class="text-right">{{ item.total|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 20px; color: #718096;">
                        No items
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Totals Section -->
        <div class="totals-section">
            <div class="totals-table">
                <div class="totals-row subtotal">
                    <span class="totals-label">Subtotal (Excl. VAT)</span>
                    <span class="totals-value">AED {{ invoice.subtotal|floatformat:2 }}</span>
                </div>
                {% for rate, amounts in vat_summary.items %}
                <div class="totals-row vat-row">
                    <span class="totals-label">VAT @ {{ rate|floatformat:0 }}%</span>
                    <span class="totals-value">AED {{ amounts.vat|floatformat:2 }}</span>
                </div>
                {% endfor %}
                <div class="totals-row">
                    <span class="totals-label">Total VAT</span>
                    <span class="totals-value">AED {{ invoice.vat_amount|floatformat:2 }}</span>
                </div>
                <div class="totals-row total">
                    <span class="totals-label">TOTAL</span>
                    <span class="totals-value">AED {{ invoice.total_amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>
        
        <!-- Amount in Words -->
        {% if amount_words %}
        <div class="amount-words">
            <div class="amount-words-label">Amount in Words</div>
            <div class="amount-words-value">{{ amount_words }}</div>
        </div>
        {% endif %}
        
        <!-- VAT Summary Table (for detailed records) -->
        <div class="vat-summary">
            <div class="vat-summary-title">VAT Summary</div>
            <table class="vat-summary-table">
                <thead>
                    <tr>
                        <th>VAT Rate</th>
                        <th>Taxable Amount (AED)</th>
                        <th>VAT Amount (AED)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rate, amounts in vat_summary.items %}
                    <tr>
                        <td>{{ rate|floatformat:0 }}% {% if rate == 5 %}Standard Rate{% elif rate == 0 %}Zero Rated{% endif %}</td>
                        <td class="text-right">{{ amounts.taxable|floatformat:2 }}</td>
                        <td class="text-right">{{ amounts.vat|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td>5% Standard Rate</td>
                        <td class="text-right">{{ invoice.subtotal|floatformat:2 }}</td>
                        <td class="text-right">{{ invoice.vat_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                    <tr style="font-weight: bold; background: #edf2f7;">
                        <td>Total</td>
                        <td class="text-right">{{ invoice.subtotal|floatformat:2 }}</td>
                        <td class="text-right">{{ invoice.vat_amount|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Notes Section -->
        {% if invoice.notes %}
        <div class="notes-section">
            <div class="notes-title">Notes & Terms</div>
            <div class="notes-content">{{ invoice.notes|linebreaks }}</div>
        </div>
        {% endif %}
        
        <!-- Bank Details (if available) -->
        <div class="notes-section">
            <div class="notes-title">Payment Information</div>
            <div class="notes-content">
                <strong>Payment Terms:</strong> Due on {{ invoice.due_date|date:"d/m/Y" }}<br>
                <strong>Currency:</strong> UAE Dirham (AED)<br>
                {% if company.email %}
                <strong>For queries:</strong> {{ company.email }}
                {% endif %}
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>This is a computer-generated invoice and does not require a signature.</p>
            
            <div class="footer-legal">
                <strong>Legal Notice:</strong> This Tax Invoice is issued in accordance with UAE Federal Decree-Law No. 8 of 2017 on Value Added Tax.
                All amounts are in UAE Dirhams (AED). Payment of VAT is the responsibility of the recipient.
                For any disputes regarding this invoice, please contact us within 7 days of receipt.
            </div>
        </div>
    </div>
    
    <script>
        // Auto-print if requested via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('print') === '1') {
            window.onload = function() {
                window.print();
            };
        }
    </script>
</body>
</html>

